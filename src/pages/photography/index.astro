---
import BaseHead from '../../components/BaseHead.astro';
import Footer from '../../components/Footer.astro';
import Header from '../../components/Header.astro';
import { SITE_DESCRIPTION, SITE_TITLE } from '../../consts';
import { getPhotoCollections } from '../../utils/photos';

const collections = getPhotoCollections();
const photos = collections.flatMap((collection) =>
	collection.items.map((item) => ({
		...item,
		tag: collection.tag,
	})),
);
const tags = ['all', ...collections.map((collection) => collection.tag)];
---

<!doctype html>
<html lang="en">
	<head>
		<BaseHead title={`${SITE_TITLE} · Photography`} description={SITE_DESCRIPTION} />
	</head>
	<body>
		<Header />
		<main>
			<div class="container">
				<section class="hero card">
					<div>
						<span class="chip">Photography</span>
						<h1>Albums powered by folders</h1>
						<p>
							Each folder becomes a tag. Drop images inside and the site renders everything automatically.
							Currently showing <strong>{photos.length}</strong> photos across <strong>
								{collections.length}
							</strong> tags.
						</p>
					</div>
					<div class="card upload-tip">
						<h3>How to add photos</h3>
						<ol>
							<li>Create a folder under <code>public/photography/</code>; the folder name is the tag.</li>
							<li>Place images (jpg, png, webp, gif, avif) inside that folder.</li>
							<li>Rebuild or refresh and the gallery will update.</li>
						</ol>
					</div>
				</section>

				<section class="filters card">
					<div class="filter-head">
						<h2>Filter by tag</h2>
						<p class="muted">Single-tag filtering. Click “All” to reset the grid.</p>
					</div>
					<div class="filter-buttons" role="group" aria-label="Tag filter">
						{tags.map((tag) => (
							<button
								type="button"
								class="filter-button"
								data-tag={tag}
								class:list={{ active: tag === 'all' }}
							>
								{tag === 'all' ? 'All' : tag}
							</button>
						))}
					</div>
				</section>

				<section>
					{photos.length > 0 ? (
						<div class="photo-grid">
							{photos.map((photo) => (
								<figure
									class="photo-card"
									data-photo
									data-tag={photo.tag}
									tabindex="0"
									role="button"
									aria-label={`View ${photo.tag} photo`}
								>
									<img src={photo.src} alt={`${photo.tag} - ${photo.filename}`} loading="lazy" />
									<figcaption>
										<span class="chip">{photo.tag}</span>
									</figcaption>
								</figure>
							))}
						</div>
					) : (
						<div class="card empty-state">
							<h3>No photos yet</h3>
							<p>
								Add at least one folder and images, e.g. <code>public/photography/travel/paris.jpg</code>, to
								populate this page.
							</p>
						</div>
					)}
				</section>
			</div>
		</main>
		<Footer />

		{photos.length > 0 && (
			<dialog id="photo-lightbox" class="lightbox" aria-label="Photo preview">
				<div class="lightbox-content">
					<button type="button" class="lightbox-close" aria-label="Close photo">&times;</button>
					<img src="" alt="" />
					<p class="muted" data-lightbox-meta></p>
				</div>
			</dialog>
		)}

		{photos.length > 0 && (
			<script>
				const buttons = document.querySelectorAll('.filter-button');
				const cards = document.querySelectorAll('[data-photo]');
				const lightbox = document.querySelector('#photo-lightbox');
				const lightboxImg = lightbox?.querySelector('img');
				const lightboxMeta = lightbox?.querySelector('[data-lightbox-meta]');
				const lightboxClose = lightbox?.querySelector('.lightbox-close');

				function setActive(tag) {
					buttons.forEach((btn) => {
						const isActive = btn.dataset.tag === tag;
						btn.classList.toggle('active', isActive);
					});

					cards.forEach((card) => {
						const cardTag = card.dataset.tag;
						const visible = tag === 'all' || cardTag === tag;
						card.style.display = visible ? '' : 'none';
					});
				}

				function openLightbox(card) {
					if (!lightbox || !lightboxImg) return;
					const img = card.querySelector('img');
					if (!img) return;

					lightboxImg.src = img.currentSrc || img.src;
					lightboxImg.alt = img.alt;

					if (lightboxMeta) {
						lightboxMeta.textContent = card.dataset.tag ? `Tag · ${card.dataset.tag}` : '';
					}

					if (typeof lightbox.showModal === 'function') {
						lightbox.showModal();
					} else {
						lightbox.setAttribute('open', '');
					}
				}

				function closeLightbox() {
					if (!lightbox) return;
					if (typeof lightbox.close === 'function') {
						lightbox.close();
					} else {
						lightbox.removeAttribute('open');
					}
				}

				buttons.forEach((button) => {
					button.addEventListener('click', () => {
						const tag = button.dataset.tag || 'all';
						setActive(tag);
					});
				});

				cards.forEach((card) => {
					card.addEventListener('click', () => openLightbox(card));
					card.addEventListener('keydown', (event) => {
						if (event.key === 'Enter' || event.key === ' ') {
							event.preventDefault();
							openLightbox(card);
						}
					});
				});

				lightboxClose?.addEventListener('click', closeLightbox);
				lightbox?.addEventListener('click', (event) => {
					if (event.target === lightbox) {
						closeLightbox();
					}
				});
			</script>
		)}
	</body>
</html>

<style>
	.hero {
		display: grid;
		grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
		gap: 2.4rem;
		margin-bottom: 4rem;
	}

	.upload-tip {
		background: var(--accent-soft);
	}

	.upload-tip ol {
		margin: 1.2rem 0 0;
		padding-left: 1.4rem;
	}

	.filters {
		margin-bottom: 3.2rem;
	}

	.filter-head {
		display: flex;
		flex-direction: column;
		gap: 0.6rem;
		margin-bottom: 1.6rem;
	}

	.filter-buttons {
		display: flex;
		flex-wrap: wrap;
		gap: 0.8rem;
	}

	.filter-button {
		padding: 0.6rem 1.4rem;
		border-radius: 999px;
		border: 1px solid transparent;
		background: rgba(79, 70, 229, 0.08);
		color: var(--accent-strong);
		font-weight: 600;
		cursor: pointer;
		transition: background 0.2s ease, border-color 0.2s ease;
	}

	.filter-button.active,
	.filter-button:hover {
		background: var(--accent);
		color: #fff;
		border-color: var(--border-soft);
	}

	.photo-grid {
		display: grid;
		grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
		gap: 2.4rem;
	}

	.photo-card {
		background: var(--bg-surface);
		box-shadow: var(--shadow-md);
		border-radius: var(--radius-md);
		overflow: hidden;
		cursor: zoom-in;
	}

	.photo-card img {
		width: 100%;
		aspect-ratio: 4 / 3;
		object-fit: cover;
	}

	.photo-card figcaption {
		display: flex;
		align-items: center;
		padding: 1.2rem 1.6rem 1.6rem;
	}

	.photo-card:focus-visible {
		outline: 3px solid var(--accent);
		outline-offset: 4px;
	}

	.empty-state {
		text-align: center;
	}

	@media (max-width: 640px) {
		.filter-buttons {
			justify-content: center;
		}
	}

	.lightbox {
		border: none;
		padding: 0;
		background: transparent;
		max-width: min(90vw, 1200px);
	}

	.lightbox::backdrop {
		background: rgba(2, 6, 23, 0.85);
	}

	.lightbox-content {
		position: relative;
		background: var(--bg-surface);
		border-radius: var(--radius-md);
		box-shadow: var(--shadow-lg, var(--shadow-md));
		padding: 1.5rem;
		display: flex;
		flex-direction: column;
		gap: 1rem;
		align-items: flex-start;
		max-height: 90vh;
	}

	.lightbox-content img {
		width: min(80vw, 960px);
		max-height: 70vh;
		object-fit: contain;
		border-radius: var(--radius-sm, 0.8rem);
	}

	.lightbox-close {
		position: absolute;
		top: 1rem;
		right: 1rem;
		border: none;
		background: rgba(15, 23, 42, 0.6);
		color: #fff;
		width: 2.5rem;
		height: 2.5rem;
		border-radius: 999px;
		font-size: 1.6rem;
		display: grid;
		place-items: center;
		cursor: pointer;
	}

	.lightbox-close:hover {
		background: rgba(15, 23, 42, 0.85);
	}
</style>

